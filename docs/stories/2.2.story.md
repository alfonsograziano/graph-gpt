# Story 2.2: Node Component with Input State

## Status
Done

## Story

**As a** user,
**I want** to see a default node with input field when I start a new conversation,
**so that** I can begin typing my first message.

## Acceptance Criteria

1. Default node is created when conversation is first accessed
2. Node contains text input field with placeholder "What do you have in mind?"
3. Submit button is positioned on the right side of the input
4. Node has light-gray background color by default
5. Input field accepts text input and handles Enter key submission
6. Node is properly positioned on the canvas
7. Node component is reusable and follows React best practices

## Tasks / Subtasks

- [x] Task 1: Create ConversationNode Component (AC: 2, 3, 4, 7)
  - [x] Create ConversationNode component in `src/components/graph/ConversationNode.tsx`
  - [x] Implement input state with text field and submit button
  - [x] Apply light-gray background styling using Tailwind CSS
  - [x] Position submit button on the right side of input
  - [x] Add proper TypeScript interfaces for props

- [x] Task 2: Implement Input Field Functionality (AC: 2, 5)
  - [x] Add text input with placeholder "What do you have in mind?"
  - [x] Handle Enter key submission
  - [x] Implement input validation and state management
  - [x] Add proper focus management and accessibility

- [x] Task 3: Create NodeInput Subcomponent (AC: 2, 3, 5)
  - [x] Create NodeInput component for input state
  - [x] Implement input field with submit button layout
  - [x] Handle text input and submission events
  - [x] Add proper styling and responsive design

- [x] Task 4: Integrate with GraphCanvas (AC: 1, 6)
  - [x] Update GraphCanvas to create default node on conversation load
  - [x] Position default node at center of canvas
  - [x] Register ConversationNode as custom node type in React Flow
  - [x] Handle node creation and positioning logic

- [x] Task 5: Implement Node State Management (AC: 1, 6)
  - [x] Add logic to create default input node when conversation is empty
  - [x] Implement node positioning system
  - [x] Handle node state transitions (input → loading → completed)
  - [x] Ensure proper node lifecycle management

- [x] Task 6: Create Unit Tests (AC: 1-7)
  - [x] Test ConversationNode component rendering
  - [x] Test input field functionality and Enter key handling
  - [x] Test submit button behavior
  - [x] Test default node creation in GraphCanvas
  - [x] Test node positioning and styling

## Dev Notes

### Previous Story Insights
**Story 2.1 Context** [Source: stories/2.1.story.md]
- React Flow is already integrated and configured
- GraphCanvas component exists with basic React Flow setup
- Canvas has proper dimensions, zoom/pan functionality, and responsive design
- TypeScript types are defined for React Flow elements

### Data Models
**Node Interface** [Source: types/index.ts]
```typescript
interface Node {
  id: string;
  conversationId: string;
  type: NodeType; // "input" | "loading" | "completed"
  userMessage: string;
  assistantResponse: string;
  position: Position; // { x: number; y: number }
  createdAt: Date;
  updatedAt: Date;
  parentNodeId?: string;
}
```

**NodeType Definition** [Source: types/index.ts]
```typescript
type NodeType = "input" | "loading" | "completed";
```

### Component Specifications
**ConversationNode Component** [Source: architecture/frontend-architecture.md#component-organization]
- Location: `src/components/graph/ConversationNode.tsx`
- Props: `node: Node`, `isActive: boolean`, `onNodeClick: (nodeId: string) => void`, `onMessageSubmit: (message: string) => void`
- Handles different node states (input, loading, completed)
- Reusable component following React best practices

**NodeInput Subcomponent** [Source: architecture/frontend-architecture.md#component-organization]
- Location: `src/components/graph/NodeInput.tsx`
- Props: `onSubmit: (message: string) => void`, `placeholder?: string`
- Handles input field with submit button
- Implements Enter key submission and validation

**UI Component Patterns** [Source: components/ui/Button.tsx, components/ui/EditableTitle.tsx]
- Button component with variants: primary, secondary, outline, ghost
- Button sizes: sm, md, lg
- Input styling: `px-2 py-1 text-lg font-semibold border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500`
- Form layout: `flex items-center space-x-2`

### File Locations
**Component Files** [Source: architecture/unified-project-structure.md]
- Main component: `src/components/graph/ConversationNode.tsx`
- Subcomponent: `src/components/graph/NodeInput.tsx`
- Types: `src/types/index.ts` (shared types)
- Tests: `tests/components/graph/ConversationNode.test.tsx`, `tests/components/graph/NodeInput.test.tsx`

**Styling** [Source: architecture/tech-stack.md]
- Tailwind CSS for styling
- Light-gray background: `bg-gray-200` or `bg-gray-100`
- Input styling: `border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500`
- Button styling: Use existing Button component patterns

### Testing Requirements
**Test File Locations** [Source: architecture/testing-strategy.md#frontend-tests]
- Test files: `tests/components/graph/ConversationNode.test.tsx`, `tests/components/graph/NodeInput.test.tsx`
- Testing framework: Jest + React Testing Library
- Test patterns: Component rendering, user interactions, form submission

**Test Standards** [Source: architecture/testing-strategy.md#frontend-component-test]
- Use `render`, `screen`, `fireEvent` from React Testing Library
- Mock node data and event handlers for testing
- Test user interactions (typing, Enter key, button clicks)
- Test component state changes and prop updates

### Technical Constraints
**React Flow Integration** [Source: architecture/tech-stack.md]
- React Flow 11+ for custom node types
- Custom node components must be registered in nodeTypes
- Node positioning using React Flow's position system

**State Management** [Source: architecture/frontend-architecture.md#state-management-patterns]
- Use React Context for global graph state
- Local state for input field management
- Proper event handling and state updates

**Accessibility** [Source: architecture/coding-standards.md]
- Proper focus management for input fields
- Keyboard navigation support
- ARIA labels and roles for screen readers

### Testing
**Test File Locations**: 
- `tests/components/graph/ConversationNode.test.tsx`
- `tests/components/graph/NodeInput.test.tsx`

**Test Standards**: 
- Use Jest + React Testing Library
- Test component rendering with mock node data
- Test user interactions (typing, Enter key, button clicks)
- Test form submission and validation
- Mock React Flow components for unit testing

**Testing Frameworks**: Jest, React Testing Library, @testing-library/jest-dom

**Specific Testing Requirements for this Story**:
- Test ConversationNode component with input state
- Test NodeInput subcomponent functionality
- Test default node creation in GraphCanvas
- Test input field validation and submission
- Test Enter key handling and button interactions

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (Dev Agent)

### Debug Log References
- Fixed text visibility issue in NodeInput component
- Resolved React Flow custom node wrapper issues
- Updated keyboard event handling from onKeyPress to onKeyDown

### Completion Notes List
- ✅ Created ConversationNode component with support for input, loading, and completed states
- ✅ Implemented NodeInput subcomponent with proper form handling and validation
- ✅ Integrated custom node types with React Flow in GraphCanvas
- ✅ Added default input node creation when conversation is empty
- ✅ Implemented proper node state management and lifecycle
- ✅ Created comprehensive unit tests for ConversationNode and NodeInput components
- ✅ Fixed UI styling issues (text color and placeholder visibility)
- ✅ Added proper TypeScript interfaces and error handling
- ✅ Implemented accessibility features (focus management, keyboard navigation)

### File List
**New Files Created:**
- `src/components/graph/ConversationNode.tsx` - Main node component with state handling
- `src/components/graph/NodeInput.tsx` - Input subcomponent for text entry
- `tests/components/graph/ConversationNode.test.tsx` - Unit tests for ConversationNode
- `tests/components/graph/NodeInput.test.tsx` - Unit tests for NodeInput
- `tests/components/graph/GraphCanvas.test.tsx` - Unit tests for GraphCanvas integration

**Modified Files:**
- `src/components/graph/GraphCanvas.tsx` - Added custom node support and default node creation
- `src/components/pages/ConversationPage.tsx` - Added message submission handling

## QA Results
*To be populated by QA Agent*
