# Story 2.6: Branch Creation and Node Positioning

## Status
Ready for Review

## Story

**As a** user,
**I want** to click the plus button to create a new input node that is properly positioned and connected,
**so that** I can continue the conversation in a new branch with clear visual relationships.

## Acceptance Criteria

1. Clicking the "+" button spawns a new node with type "input"
2. New node is positioned below the current node with proper spacing
3. An edge is automatically created connecting from bottom of current node to top of new node
4. New node appears with input field ready for user interaction
5. Node positioning maintains proper visual hierarchy and spacing
6. Edge connection is visually clear and properly styled
7. New node becomes the active node and is ready for user input
8. Everything is fully sync with the backend - every time a new node or edge gets updated on the UI update the backend as well

## Tasks / Subtasks

- [x] Task 1: Implement Node Creation Logic (AC: 1, 4, 7)
  - [x] Create function to generate new input node with unique ID
  - [x] Set node type to "input" with empty userMessage and assistantResponse
  - [x] Initialize node with proper conversationId and timestamps
  - [x] Set parentNodeId to reference the current node
  - [x] Ensure new node is ready for user interaction

- [x] Task 2: Implement Node Positioning Algorithm (AC: 2, 5)
  - [x] Calculate position below current node with proper vertical spacing
  - [x] Maintain horizontal alignment with parent node
  - [x] Implement spacing constants for consistent node positioning
  - [x] Handle edge cases for nodes at canvas boundaries
  - [x] Ensure positioning works with different node sizes

- [x] Task 3: Create Edge Connection Logic (AC: 3, 6)
  - [x] Generate unique edge ID and metadata
  - [x] Set sourceNodeId to current node and targetNodeId to new node
  - [x] Configure edge type as "auto" for branch creation
  - [x] Implement proper edge styling and visual appearance
  - [x] Ensure edge connects from bottom of source to top of target

- [x] Task 4: Update GraphCanvas Component (AC: 1-7)
  - [x] Add branch creation handler to GraphCanvas
  - [x] Implement node and edge addition to React Flow
  - [x] Update conversation state with new node and edge
  - [x] Handle node activation and focus management
  - [x] Ensure proper state synchronization with backend

- [x] Task 5: Enhance BranchButton Component (AC: 1, 7)
  - [x] Add onClick handler for branch creation
  - [x] Implement proper event handling and state updates
  - [x] Add loading state during node creation
  - [x] Ensure button remains accessible and responsive
  - [x] Add proper error handling for creation failures

- [x] Task 6: Update State Management (AC: 1, 4, 7)
  - [x] Add node creation actions to GraphContext
  - [x] Implement edge creation in conversation state
  - [x] Update activeNodePath to include new node
  - [x] Ensure proper state immutability and updates
  - [x] Handle state persistence and synchronization

- [x] Task 7: Create Unit Tests (AC: 1-7)
  - [x] Test node creation with proper attributes
  - [x] Test positioning algorithm with various scenarios
  - [x] Test edge creation and connection logic
  - [x] Test state management and updates
  - [x] Test error handling and edge cases

## Dev Notes

### Previous Story Insights
**Story 2.5 Context** [Source: stories/2.5.story.md]
- Node activation and path calculation functionality is implemented
- GraphContext manages activeNodePath state
- Node clicking and activation logic is working
- Path calculation handles complex branching scenarios

**Story 2.4 Context** [Source: stories/2.4.story.md]
- Node completion and branch creation button functionality is implemented
- NodeCompleted component displays user message, separator, and LLM response
- Circular "+" button for branch creation is available
- Node background changes to white when active
- Markdown rendering for LLM responses is complete

**Story 2.3 Context** [Source: stories/2.3.story.md]
- Node state management and loading states are implemented
- ConversationNode component handles input and loading states
- NodeLoading component exists for loading state display
- State transitions from input → loading → completed are working

**Story 2.2 Context** [Source: stories/2.2.story.md]
- ConversationNode component exists with input state
- NodeInput subcomponent handles input field and submission
- Default node creation and positioning is implemented
- React Flow integration is complete

**Story 2.1 Context** [Source: stories/2.1.story.md]
- React Flow canvas is integrated and configured
- GraphCanvas component handles node positioning and layout
- TypeScript types are defined for React Flow elements

### Data Models
**Node Interface** [Source: types/index.ts]
```typescript
interface Node {
  id: string;
  conversationId: string;
  type: NodeType; // "input" | "loading" | "completed"
  userMessage: string;
  assistantResponse: string;
  position: Position; // { x: number; y: number }
  createdAt: Date;
  updatedAt: Date;
  parentNodeId?: string;
}
```

**Edge Interface** [Source: types/index.ts]
```typescript
interface Edge {
  id: string;
  conversationId: string;
  sourceNodeId: string;
  targetNodeId: string;
  type: EdgeType; // "auto" | "manual" | "markdown"
  createdAt: Date;
  metadata?: EdgeMetadata;
}
```

**Position Interface** [Source: types/index.ts]
```typescript
interface Position {
  x: number;
  y: number;
}
```

### Component Specifications
**GraphCanvas Component** [Source: architecture/frontend-architecture.md#component-organization]
- Location: `src/components/graph/GraphCanvas.tsx`
- Props: `conversation: Conversation`, `onNodeClick: (nodeId: string) => void`
- Handles React Flow canvas and node positioning
- **NEW**: Implements branch creation and node positioning logic

**BranchButton Component** [Source: architecture/frontend-architecture.md#component-organization]
- Location: `src/components/graph/BranchButton.tsx`
- Props: `onClick: () => void`, `disabled?: boolean`
- Circular "+" button for creating new branches
- **NEW**: Handles branch creation with proper positioning

**ConversationNode Component** [Source: architecture/frontend-architecture.md#component-organization]
- Location: `src/components/graph/ConversationNode.tsx`
- Props: `node: Node`, `isActive: boolean`, `onNodeClick: (nodeId: string) => void`, `onMessageSubmit: (message: string) => void`
- Handles different node states (input, loading, completed)
- **NEW**: Supports new input node creation and activation

**GraphContext Component** [Source: architecture/frontend-architecture.md#component-organization]
- Location: `src/context/GraphContext.tsx`
- Provides global graph state management
- **NEW**: Manages node and edge creation, positioning logic

### File Locations
**Component Files** [Source: architecture/unified-project-structure.md]
- Main component: `src/components/graph/GraphCanvas.tsx`
- Branch button: `src/components/graph/BranchButton.tsx`
- Node component: `src/components/graph/ConversationNode.tsx`
- Context: `src/context/GraphContext.tsx`
- Types: `src/types/index.ts` (shared types)
- Tests: `tests/components/graph/GraphCanvas.test.tsx`, `tests/components/graph/BranchButton.test.tsx`

**Styling** [Source: architecture/tech-stack.md]
- Tailwind CSS for styling
- Node positioning: `transform: translate(x, y)`
- Edge styling: `stroke: #3b82f6`, `stroke-width: 2`
- Spacing constants: `NODE_SPACING = 120`, `EDGE_OFFSET = 20`
- Smooth transitions: `transition-all duration-200`

### State Management
**Node Creation Logic** [Source: architecture/frontend-architecture.md#state-management-patterns]
- Generate unique node ID using UUID
- Set node type to "input" for new branches
- Calculate position below parent node
- Set parentNodeId for proper hierarchy
- Update conversation state with new node

**Edge Creation Logic** [Source: architecture/frontend-architecture.md#state-management-patterns]
- Generate unique edge ID
- Set sourceNodeId to current node
- Set targetNodeId to new node
- Configure edge type as "auto"
- Update conversation state with new edge

**Positioning Algorithm** [Source: architecture/frontend-architecture.md#state-management-patterns]
- Calculate vertical offset below parent node
- Maintain horizontal alignment
- Handle canvas boundary constraints
- Ensure proper spacing between nodes
- Support different node sizes and content

### Technical Constraints
**Node Positioning** [Source: architecture/frontend-architecture.md#state-management-patterns]
- Must maintain proper visual hierarchy
- Handle canvas boundary constraints
- Support different node sizes and content
- Ensure consistent spacing between nodes
- Work with React Flow positioning system

**Edge Connection** [Source: architecture/frontend-architecture.md#state-management-patterns]
- Connect from bottom of source node to top of target
- Maintain proper visual styling
- Handle different node sizes
- Ensure edge doesn't overlap with content
- Support proper edge routing

**State Management** [Source: architecture/frontend-architecture.md#state-management-patterns]
- Use React Context for global graph state
- Immutable state updates through reducers
- Proper error handling for creation failures
- State synchronization with backend
- Optimistic updates with rollback on failure

### Performance Considerations
**Node Creation** [Source: architecture/frontend-architecture.md#state-management-patterns]
- Efficient node ID generation
- Optimized state updates
- Proper memoization for expensive operations
- Smooth animations for node appearance
- Minimal re-renders during creation

**Positioning Algorithm** [Source: architecture/frontend-architecture.md#state-management-patterns]
- Efficient position calculation
- Cached positioning constants
- Optimized React Flow updates
- Smooth transitions and animations
- Proper cleanup and memory management

### Testing Requirements
**Test File Locations** [Source: architecture/testing-strategy.md#frontend-tests]
- Test files: `tests/components/graph/GraphCanvas.test.tsx`, `tests/components/graph/BranchButton.test.tsx`
- Testing framework: Jest + React Testing Library
- Test patterns: Component rendering, user interactions, state management, positioning logic

**Test Standards** [Source: architecture/testing-strategy.md#frontend-component-test]
- Use `render`, `screen`, `fireEvent` from React Testing Library
- Mock node data and state management for testing
- Test node creation with proper attributes
- Test positioning algorithm with various scenarios
- Test edge creation and connection logic

**Specific Testing Requirements for this Story**:
- Test node creation with proper attributes and positioning
- Test edge creation and connection logic
- Test state management and updates
- Test positioning algorithm with various scenarios
- Test error handling and edge cases

### Accessibility
**Node Creation** [Source: architecture/coding-standards.md]
- Proper ARIA labels for new nodes
- Screen reader support for branch creation
- Keyboard navigation for branch button
- Focus management for new nodes
- Proper semantic markup

**Edge Connection** [Source: architecture/coding-standards.md]
- Visual indicators for edge connections
- Proper contrast and visibility
- Screen reader support for graph structure
- Keyboard navigation for edge interactions
- Proper focus management

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
*To be populated by Dev Agent*

### Debug Log References
*To be populated by Dev Agent*

### Completion Notes List
*To be populated by Dev Agent*

### File List
*To be populated by Dev Agent*

## QA Results
*To be populated by QA Agent*
