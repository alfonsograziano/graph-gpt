# Story 3.5: Mock API for Development

## Status
Draft

## Story

**As a** developer,
**I want** to have a mock OpenAI API for development and testing,
**so that** I can develop without external API dependencies.

## Acceptance Criteria

1. Mock API route provides consistent markdown responses
2. Mock responses include various markdown elements for testing
3. Mock API simulates streaming behavior for realistic testing
4. Mock responses are configurable for different test scenarios
5. Development environment automatically uses mock API
6. Mock API maintains same interface as real OpenAI API
7. Mock responses are realistic and useful for development

## Tasks / Subtasks

- [ ] Task 1: Create Mock API Route (AC: 1, 6)
  - [ ] Create `/api/chat/mock` route for development
  - [ ] Implement same interface as real OpenAI API
  - [ ] Add environment-based routing logic
  - [ ] Create mock response templates
  - [ ] Add configuration for mock behavior

- [ ] Task 2: Implement Mock Response Templates (AC: 2, 7)
  - [ ] Create diverse markdown response templates
  - [ ] Include code blocks, lists, headers, and tables
  - [ ] Add realistic conversation responses
  - [ ] Create different response types for testing
  - [ ] Add configurable response complexity

- [ ] Task 3: Add Streaming Simulation (AC: 3)
  - [ ] Implement mock streaming responses
  - [ ] Simulate realistic streaming delays
  - [ ] Add configurable streaming behavior
  - [ ] Handle streaming errors and interruptions
  - [ ] Add streaming configuration options

- [ ] Task 4: Create Mock Configuration System (AC: 4, 5)
  - [ ] Add environment variable for mock mode
  - [ ] Create mock response configuration
  - [ ] Add scenario-based response selection
  - [ ] Implement mock response customization
  - [ ] Add development mode detection

- [ ] Task 5: Add Mock Utilities and Helpers (AC: 4, 7)
  - [ ] Create mock response generators
  - [ ] Add mock data utilities
  - [ ] Implement response validation
  - [ ] Add mock debugging tools
  - [ ] Create mock response testing utilities

- [ ] Task 6: Create Unit Tests (AC: 1-7)
  - [ ] Test mock API route functionality
  - [ ] Test mock response generation
  - [ ] Test streaming simulation
  - [ ] Test configuration system
  - [ ] Test mock utilities and helpers

## Dev Notes

### Previous Story Insights
**Story 3.4 Context** [Source: stories/3.4.story.md]
- Markdown rendering and display are implemented
- MarkdownRenderer component handles various content types
- Progressive rendering for streaming is working
- Content containment and styling are complete

**Story 3.3 Context** [Source: stories/3.3.story.md]
- Streaming response implementation is complete
- Server-Sent Events integration is working
- Connection management and error handling are in place

### Data Models
**MockResponse Interface** [Source: architecture/api-specification.md#chat-endpoint]
```typescript
interface MockResponse {
  content: string;
  nodeId: string;
  conversationId: string;
  timestamp: Date;
  metadata: {
    isMock: boolean;
    templateId: string;
    complexity: 'simple' | 'medium' | 'complex';
    streamingDelay: number;
  };
}
```

**MockConfig Interface** [Source: architecture/backend-architecture.md#service-architecture]
```typescript
interface MockConfig {
  enabled: boolean;
  responseDelay: number;
  streamingDelay: number;
  errorRate: number;
  templatePath: string;
  scenarios: MockScenario[];
}
```

**MockScenario Interface** [Source: architecture/backend-architecture.md#service-architecture]
```typescript
interface MockScenario {
  id: string;
  name: string;
  description: string;
  responseTemplate: string;
  conditions: {
    messageContains?: string[];
    contextLength?: number;
    nodeType?: string;
  };
}
```

### API Specifications
**Mock Chat Endpoint** [Source: architecture/api-specification.md#chat-endpoint]
- Route: `POST /api/chat/mock`
- Interface: Same as real OpenAI API
- Response: Mock responses with realistic content
- Configuration: Environment-based activation

**Mock Streaming Endpoint** [Source: architecture/api-specification.md#chat-endpoint]
- Route: `POST /api/chat/mock/stream`
- Protocol: Server-Sent Events (SSE)
- Behavior: Simulates real streaming with delays
- Configuration: Adjustable streaming parameters

### Component Specifications
**MockChatService** [Source: architecture/backend-architecture.md#service-architecture]
- Location: `src/services/mockChatService.ts`
- Functions: `generateMockResponse`, `simulateStreaming`, `selectScenario`
- Manages mock response generation
- Handles mock streaming simulation

**MockResponseGenerator** [Source: architecture/backend-architecture.md#service-architecture]
- Location: `src/utils/mockResponseGenerator.ts`
- Functions: `generateResponse`, `selectTemplate`, `addMarkdownElements`
- Creates realistic mock responses
- Handles different response types and complexity

**MockConfigService** [Source: architecture/backend-architecture.md#service-architecture]
- Location: `src/services/mockConfigService.ts`
- Functions: `loadConfig`, `selectScenario`, `updateConfig`
- Manages mock configuration
- Handles scenario selection and customization

### File Locations
**API Route Files** [Source: architecture/backend-architecture.md#function-organization]
- Mock chat route: `src/app/api/chat/mock/route.ts`
- Mock streaming route: `src/app/api/chat/mock/stream/route.ts`
- Mock health check: `src/app/api/chat/mock/health/route.ts`

**Service Files** [Source: architecture/backend-architecture.md#service-architecture]
- Mock chat service: `src/services/mockChatService.ts`
- Mock config service: `src/services/mockConfigService.ts`
- Mock response generator: `src/utils/mockResponseGenerator.ts`

**Configuration Files** [Source: architecture/unified-project-structure.md]
- Mock templates: `src/mock/templates/`
- Mock scenarios: `src/mock/scenarios/`
- Mock config: `src/mock/config.json`

### Mock Response Templates
**Template Structure** [Source: architecture/backend-architecture.md#service-architecture]
- Simple responses: Basic text with minimal formatting
- Medium responses: Text with lists, headers, and basic formatting
- Complex responses: Full markdown with code blocks, tables, and advanced formatting

**Template Examples** [Source: architecture/backend-architecture.md#service-architecture]
- Code explanation responses
- List-based responses
- Table-based responses
- Multi-section responses
- Error simulation responses

### Streaming Simulation
**Mock Streaming Behavior** [Source: architecture/backend-architecture.md#service-architecture]
- Simulate realistic streaming delays
- Chunk responses into realistic sizes
- Add configurable streaming parameters
- Handle streaming errors and interruptions

**Streaming Configuration** [Source: architecture/backend-architecture.md#service-architecture]
- Chunk size: Configurable response chunk size
- Delay: Adjustable delay between chunks
- Error simulation: Configurable error rates
- Interruption handling: Simulate connection issues

### Environment Configuration
**Development Mode Detection** [Source: architecture/development-workflow.md#environment-configuration]
- Environment variable: `USE_MOCK_API=true`
- Automatic detection in development
- Configuration override capabilities
- Environment-specific mock settings

**Mock Configuration** [Source: architecture/development-workflow.md#environment-configuration]
- Response templates and scenarios
- Streaming behavior configuration
- Error simulation settings
- Performance and delay settings

### Mock Scenarios
**Response Scenarios** [Source: architecture/backend-architecture.md#service-architecture]
- Technical explanations
- Code examples and tutorials
- List-based responses
- Table-based data
- Error responses and edge cases

**Scenario Selection** [Source: architecture/backend-architecture.md#service-architecture]
- Message content analysis
- Context length consideration
- Node type matching
- Random selection for variety

### Testing and Development
**Mock Testing** [Source: architecture/testing-strategy.md#backend-tests]
- Test mock API functionality
- Test response generation
- Test streaming simulation
- Test configuration system

**Development Benefits** [Source: architecture/development-workflow.md#local-development-setup]
- No external API dependencies
- Consistent response behavior
- Configurable testing scenarios
- Faster development iteration

### Performance Considerations
**Mock Performance** [Source: architecture/security-and-performance.md#performance-optimization]
- Fast response generation
- Efficient template processing
- Minimal memory usage
- Realistic performance simulation

**Development Optimization** [Source: architecture/security-and-performance.md#performance-optimization]
- Quick response times for development
- Configurable delays for testing
- Efficient template caching
- Optimized response generation

### Error Handling
**Mock Error Simulation** [Source: architecture/error-handling-strategy.md#backend-error-handling]
- Configurable error rates
- Different error types
- Error recovery simulation
- Network error simulation

**Mock Error Handling** [Source: architecture/error-handling-strategy.md#backend-error-handling]
- Graceful error responses
- Error logging and debugging
- Fallback response generation
- Error configuration management

### Security Considerations
**Mock Security** [Source: architecture/security-and-performance.md#security-requirements]
- Safe template processing
- Input validation for mock requests
- Secure configuration handling
- No sensitive data in mock responses

**Development Security** [Source: architecture/security-and-performance.md#security-requirements]
- Environment-based activation
- Secure configuration storage
- Safe template execution
- Input sanitization

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
*To be populated by Dev Agent*

### Debug Log References
*To be populated by Dev Agent*

### Completion Notes List
*To be populated by Dev Agent*

### File List
*To be populated by Dev Agent*

## QA Results
*To be populated by QA Agent*
