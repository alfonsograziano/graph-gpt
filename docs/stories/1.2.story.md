# Story 1.2: Conversation Data Model and API

## Status
Done

## Story
**As a** developer,
**I want** to implement the conversation data model and basic CRUD operations,
**so that** conversations can be created, retrieved, updated, and deleted.

## Acceptance Criteria
1. Mongoose schema is defined for Conversation entity with all required fields
2. API routes are created for conversation CRUD operations (/api/conversations)
3. Conversation data includes nodes, edges, positions, title, and metadata
4. Data validation is implemented for conversation schema
5. Error handling is implemented for database operations
6. API responses follow consistent format with proper HTTP status codes

## Tasks / Subtasks
- [x] Task 1: Create Mongoose schemas for Conversation, Node, and Edge (AC: 1, 3)
  - [x] Define PositionSchema for node positioning
  - [x] Define NodeSchema with all required fields and validation
  - [x] Define EdgeSchema with source/target relationships
  - [x] Define ConversationSchema with embedded nodes and edges
  - [x] Add proper validation rules and constraints
- [x] Task 2: Implement ConversationRepository data access layer (AC: 1, 5)
  - [x] Create CRUD methods: create, findById, findAll, update, delete
  - [x] Implement proper error handling for database operations
  - [x] Add data validation before database operations
  - [x] Follow repository pattern for data access
- [x] Task 3: Create API routes for conversation CRUD operations (AC: 2, 6)
  - [x] Implement GET /api/conversations (list all conversations)
  - [x] Implement POST /api/conversations (create new conversation)
  - [x] Implement GET /api/conversations/[id] (get specific conversation)
  - [x] Implement PUT /api/conversations/[id] (update conversation)
  - [x] Implement DELETE /api/conversations/[id] (delete conversation)
- [x] Task 4: Implement data validation and error handling (AC: 4, 5)
  - [x] Add request body validation for all endpoints
  - [x] Implement consistent error response format
  - [x] Add proper HTTP status codes for all responses
  - [x] Handle database connection errors gracefully
- [x] Task 5: Create comprehensive test suite (AC: 1-6)
  - [x] Unit tests for Mongoose schemas and validation
  - [x] Unit tests for ConversationRepository methods
  - [x] Integration tests for all API endpoints
  - [x] Error handling tests for database failures
  - [x] Test data validation and error responses

## Dev Notes

### Previous Story Insights
From Story 1.1 completion:
- Database connection utility is already implemented in `src/lib/database.ts`
- TypeScript types are defined in `src/types/index.ts`
- Error handling utilities are available in `src/utils/errorHandler.ts`
- Health check API endpoint exists at `/api/health`
- Jest testing framework is configured and ready

### Data Models
**Mongoose Schema Structure:**
```typescript
// Position Schema
const PositionSchema = new mongoose.Schema({
  x: { type: Number, required: true },
  y: { type: Number, required: true }
});

// Node Schema
const NodeSchema = new mongoose.Schema({
  id: { type: String, required: true, unique: true },
  type: { type: String, enum: ['input', 'loading', 'completed'], required: true },
  userMessage: { type: String, required: true },
  assistantResponse: { type: String, default: '' },
  position: { type: PositionSchema, required: true },
  createdAt: { type: Date, default: Date.now },
  updatedAt: { type: Date, default: Date.now },
  parentNodeId: { type: String, required: false }
});

// Edge Schema
const EdgeSchema = new mongoose.Schema({
  id: { type: String, required: true, unique: true },
  sourceNodeId: { type: String, required: true },
  targetNodeId: { type: String, required: true },
  type: { type: String, enum: ['auto', 'manual', 'markdown'], required: true },
  createdAt: { type: Date, default: Date.now },
  metadata: {
    markdownElementId: { type: String, required: false },
    contextSnippet: { type: String, required: false }
  }
});

// Conversation Schema
const ConversationSchema = new mongoose.Schema({
  id: { type: String, required: true, unique: true },
  title: { type: String, required: true },
  createdAt: { type: Date, default: Date.now },
  updatedAt: { type: Date, default: Date.now },
  nodes: [NodeSchema],
  edges: [EdgeSchema],
  metadata: {
    nodeCount: { type: Number, default: 0 },
    lastActiveNodeId: { type: String, required: false },
    tags: [{ type: String }]
  }
});
```
[Source: architecture/backend-architecture.md#schema-design]

**TypeScript Interfaces (already defined in Story 1.1):**
- Conversation interface with all required fields
- Node interface with type, position, and relationships
- Edge interface with source/target connections
- Supporting interfaces (Position, NodeType, EdgeType)
[Source: architecture/data-models.md]

### API Specifications
**REST API Endpoints:**
- `GET /api/conversations` - List all conversations
- `POST /api/conversations` - Create new conversation
- `GET /api/conversations/[id]` - Get specific conversation
- `PUT /api/conversations/[id]` - Update conversation
- `DELETE /api/conversations/[id]` - Delete conversation

**Request/Response Formats:**
```typescript
// POST /api/conversations request body
{
  title: string
}

// Response format (all endpoints)
{
  id: string,
  title: string,
  createdAt: Date,
  updatedAt: Date,
  nodes: Node[],
  edges: Edge[],
  metadata: ConversationMetadata
}
```
[Source: architecture/api-specification.md#rest-api-specification]

**HTTP Status Codes:**
- 200: Success (GET, PUT)
- 201: Created (POST)
- 204: No Content (DELETE)
- 400: Bad Request (validation errors)
- 404: Not Found (conversation not found)
- 500: Internal Server Error (database errors)
[Source: architecture/api-specification.md#rest-api-specification]

### File Locations
**API Routes to Create:**
- `src/app/api/conversations/route.ts` - Main conversations endpoint
- `src/app/api/conversations/[id]/route.ts` - Individual conversation endpoint

**Data Access Layer:**
- `src/services/conversationService.ts` - Service layer for conversation operations
- `src/lib/models/Conversation.ts` - Mongoose model definition

**Repository Pattern:**
- `src/services/repositories/ConversationRepository.ts` - Data access methods
[Source: architecture/backend-architecture.md#function-organization]

### Database Schema
**MongoDB Collections Structure:**
```javascript
// conversations collection
{
  _id: ObjectId,
  id: String, // UUID for frontend reference
  title: String,
  createdAt: Date,
  updatedAt: Date,
  nodes: [
    {
      id: String,
      type: String, // 'input' | 'loading' | 'completed'
      userMessage: String,
      assistantResponse: String,
      position: {
        x: Number,
        y: Number
      },
      createdAt: Date,
      updatedAt: Date,
      parentNodeId: String // optional
    }
  ],
  edges: [
    {
      id: String,
      sourceNodeId: String,
      targetNodeId: String,
      type: String, // 'auto' | 'manual' | 'markdown'
      createdAt: Date,
      metadata: {
        markdownElementId: String, // optional
        contextSnippet: String // optional
      }
    }
  ],
  metadata: {
    nodeCount: Number,
    lastActiveNodeId: String, // optional
    tags: [String] // optional
  }
}
```
[Source: architecture/database-schema.md#mongodb-collections]

**Required Indexes:**
- `db.conversations.createIndex({ "id": 1 }, { unique: true })`
- `db.conversations.createIndex({ "createdAt": -1 })`
- `db.conversations.createIndex({ "updatedAt": -1 })`
- `db.conversations.createIndex({ "nodes.id": 1 })`
- `db.conversations.createIndex({ "edges.sourceNodeId": 1 })`
- `db.conversations.createIndex({ "edges.targetNodeId": 1 })`
[Source: architecture/database-schema.md#mongodb-collections]

### Technical Constraints
- **Next.js API Routes:** Use App Router pattern with route.ts files
- **Mongoose Version:** Latest version for MongoDB integration
- **Error Handling:** Use standard error handler from `src/utils/errorHandler.ts`
- **Type Safety:** All API responses must match TypeScript interfaces
- **Validation:** Use Mongoose validation and custom validation functions
- **Repository Pattern:** Never access database directly from API routes
[Source: architecture/coding-standards.md, architecture/backend-architecture.md]

### Testing Requirements
**Test File Locations:**
- `tests/api/conversations.test.ts` - API endpoint tests
- `tests/services/conversationService.test.ts` - Service layer tests
- `tests/lib/models/Conversation.test.ts` - Model validation tests

**Testing Standards:**
- **Backend Testing:** Jest + Supertest for API testing
- **Test Organization:** Follow testing pyramid with unit tests, integration tests
- **Mocking:** Mock database operations for unit tests
- **Integration Tests:** Test actual database operations
[Source: architecture/testing-strategy.md#backend-tests]

**Specific Test Cases:**
- Unit tests for Mongoose schema validation
- Unit tests for ConversationRepository CRUD methods
- Integration tests for all API endpoints (GET, POST, PUT, DELETE)
- Error handling tests for database connection failures
- Validation tests for request body validation
- HTTP status code verification for all endpoints
[Source: architecture/testing-strategy.md#backend-api-test]

### Project Structure Notes
The current project structure already has:
- `src/app/api/` directory exists
- `src/services/` directory exists
- `src/lib/` directory exists
- Database connection utility in `src/lib/database.ts`
- Error handling utilities in `src/utils/errorHandler.ts`

The main work is to:
1. Create the Mongoose models in `src/lib/models/`
2. Implement the service layer in `src/services/`
3. Create the API routes in `src/app/api/conversations/`
4. Follow the repository pattern for data access
5. Ensure proper separation of concerns following coding standards

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (via Cursor)

### Debug Log References
- All tests passing: 78/78 tests passed
- Jest configuration fixed: moduleNameMapper corrected
- Database mocking issues resolved
- Model validation tests implemented with proper mocking

### Completion Notes List
- ✅ Created comprehensive Mongoose schemas for Conversation, Node, and Edge with proper validation
- ✅ Implemented ConversationRepository with full CRUD operations and error handling
- ✅ Built service layer (ConversationService) with business logic validation
- ✅ Created Next.js API routes for all CRUD operations with proper HTTP status codes
- ✅ Implemented comprehensive test suite with 78 passing tests
- ✅ Fixed Jest configuration issues and database mocking
- ✅ All acceptance criteria met and validated through testing

### File List
**New Files Created:**
- `src/lib/models/Conversation.ts` - Mongoose schemas and model definitions
- `src/services/repositories/ConversationRepository.ts` - Data access layer
- `src/services/conversationService.ts` - Service layer with business logic
- `src/app/api/conversations/route.ts` - Main conversations API endpoint
- `src/app/api/conversations/[id]/route.ts` - Individual conversation API endpoint
- `tests/lib/models/Conversation.test.ts` - Model validation tests
- `tests/services/conversationService.test.ts` - Service layer tests
- `tests/api/conversations.test.ts` - API endpoint tests

**Modified Files:**
- `jest.config.mjs` - Fixed moduleNameMapper configuration

## QA Results
*Results from QA Agent review will be populated here after implementation*
