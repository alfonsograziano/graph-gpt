# Story 1.1: Project Setup and Database Configuration

## Status
Done

## Story
**As a** developer,
**I want** to set up the Next.js project with TypeScript, MongoDB, and Mongoose,
**so that** I have a solid foundation for building the graph-based LLM interface.

## Acceptance Criteria
1. Next.js project is initialized with TypeScript configuration
2. MongoDB connection is established using Mongoose
3. Shared TypeScript types are defined for Conversation, Node, and Edge entities
4. Basic project structure is organized with proper separation of concerns
5. Environment variables are configured for database connection
6. Basic error handling and logging are implemented

## Tasks / Subtasks
- [x] Task 1: Initialize Next.js project with TypeScript (AC: 1)
  - [x] Verify Next.js 15+ is installed with TypeScript 5.3+
  - [x] Configure tsconfig.json with proper settings
  - [x] Set up App Router structure in src/app/
- [x] Task 2: Set up MongoDB connection with Mongoose (AC: 2, 5)
  - [x] Install mongoose dependency
  - [x] Create database connection utility in src/lib/
  - [x] Configure environment variables for MongoDB connection
  - [x] Implement connection error handling
- [x] Task 3: Define shared TypeScript types (AC: 3)
  - [x] Create src/types/ directory structure
  - [x] Define Conversation interface with all required fields
  - [x] Define Node interface with type, position, and relationships
  - [x] Define Edge interface with source/target connections
  - [x] Define supporting interfaces (Position, NodeType, EdgeType)
- [x] Task 4: Organize project structure (AC: 4)
  - [x] Create src/components/ directory with ui/, graph/, layout/, pages/ subdirectories
  - [x] Create src/hooks/, src/context/, src/services/ directories
  - [x] Create src/utils/ and src/lib/ directories
  - [x] Set up tests/ directory with components/, api/, e2e/ subdirectories
- [x] Task 5: Implement error handling and logging (AC: 6)
  - [x] Create error handling utilities in src/utils/
  - [x] Set up logging configuration
  - [x] Implement database connection error handling
  - [x] Add basic API error response formatting

## Dev Notes

### Previous Story Insights
This is the first story in the project, so no previous story context exists.

### Data Models
**Conversation Interface:**
```typescript
interface Conversation {
  id: string;
  title: string;
  createdAt: Date;
  updatedAt: Date;
  nodes: Node[];
  edges: Edge[];
  metadata: ConversationMetadata;
}

interface ConversationMetadata {
  nodeCount: number;
  lastActiveNodeId?: string;
  tags?: string[];
}
```
[Source: architecture/data-models.md#conversation]

**Node Interface:**
```typescript
interface Node {
  id: string;
  conversationId: string;
  type: 'input' | 'loading' | 'completed';
  userMessage: string;
  assistantResponse: string;
  position: Position;
  createdAt: Date;
  updatedAt: Date;
  parentNodeId?: string;
}

interface Position {
  x: number;
  y: number;
}

type NodeType = 'input' | 'loading' | 'completed';
```
[Source: architecture/data-models.md#node]

**Edge Interface:**
```typescript
interface Edge {
  id: string;
  conversationId: string;
  sourceNodeId: string;
  targetNodeId: string;
  type: 'auto' | 'manual' | 'markdown';
  createdAt: Date;
  metadata?: EdgeMetadata;
}

interface EdgeMetadata {
  markdownElementId?: string;
  contextSnippet?: string;
}

type EdgeType = 'auto' | 'manual' | 'markdown';
```
[Source: architecture/data-models.md#edge]

### Database Schema
**MongoDB Collections Structure:**
```javascript
// conversations collection
{
  _id: ObjectId,
  id: String, // UUID for frontend reference
  title: String,
  createdAt: Date,
  updatedAt: Date,
  nodes: [
    {
      id: String,
      type: String, // 'input' | 'loading' | 'completed'
      userMessage: String,
      assistantResponse: String,
      position: {
        x: Number,
        y: Number
      },
      createdAt: Date,
      updatedAt: Date,
      parentNodeId: String // optional
    }
  ],
  edges: [
    {
      id: String,
      sourceNodeId: String,
      targetNodeId: String,
      type: String, // 'auto' | 'manual' | 'markdown'
      createdAt: Date,
      metadata: {
        markdownElementId: String, // optional
        contextSnippet: String // optional
      }
    }
  ],
  metadata: {
    nodeCount: Number,
    lastActiveNodeId: String, // optional
    tags: [String] // optional
  }
}
```
[Source: architecture/database-schema.md#mongodb-collections]

**Required Indexes:**
- `db.conversations.createIndex({ "id": 1 }, { unique: true })`
- `db.conversations.createIndex({ "createdAt": -1 })`
- `db.conversations.createIndex({ "updatedAt": -1 })`
- `db.conversations.createIndex({ "nodes.id": 1 })`
- `db.conversations.createIndex({ "edges.sourceNodeId": 1 })`
- `db.conversations.createIndex({ "edges.targetNodeId": 1 })`
[Source: architecture/database-schema.md#mongodb-collections]

### File Locations
**Project Structure to Create:**
```
src/
├── app/                    # App Router (already exists)
│   ├── api/                # API routes (to be created)
│   ├── chat/[id]/          # Conversation pages (to be created)
│   ├── globals.css         # (already exists)
│   ├── layout.tsx          # (already exists)
│   └── page.tsx            # (already exists)
├── components/             # React components (to be created)
│   ├── ui/                 # Reusable UI components
│   ├── graph/              # Graph-specific components
│   ├── layout/             # Layout components
│   └── pages/              # Page components
├── hooks/                  # Custom React hooks (to be created)
├── context/                # React Context providers (to be created)
├── services/               # API service layer (to be created)
├── types/                  # TypeScript type definitions (to be created)
├── utils/                  # Utility functions (to be created)
└── lib/                    # Configuration and utilities (to be created)
```
[Source: architecture/unified-project-structure.md]

**Database Connection File:** `src/lib/database.ts`
**Type Definitions:** `src/types/index.ts`
**Error Handling:** `src/utils/errorHandler.ts`

### Technical Constraints
- **Next.js Version:** 15+required
- **TypeScript Version:** 5.3+ required
- **MongoDB Version:** 7+ required
- **Mongoose:** Latest version for MongoDB integration
- **Environment Variables:** Must be accessed through config objects, never `process.env` directly
[Source: architecture/tech-stack.md, architecture/coding-standards.md]

### Testing
**Testing Standards:**
- **Test File Location:** `tests/` directory with subdirectories for `components/`, `api/`, and `e2e/`
- **Testing Frameworks:** Jest + React Testing Library for frontend, Jest + Supertest for backend
- **Test Organization:** Follow testing pyramid with unit tests, integration tests, and E2E tests
- **Backend Testing:** Use Jest + Supertest for API testing
- **Test Examples:** Follow patterns defined in testing-strategy.md
[Source: architecture/testing-strategy.md]

**Specific Testing Requirements for this Story:**
- Unit tests for database connection utilities
- Unit tests for TypeScript type definitions
- Integration tests for MongoDB connection
- Error handling tests for database connection failures

### Project Structure Notes
The current project structure already has the basic Next.js App Router setup in `src/app/`. The main work is to:
1. Create the additional directory structure as defined in unified-project-structure.md
2. Set up the database connection and type definitions
3. Ensure proper separation of concerns following the coding standards

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record
*This section has been populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (dev agent)

### Debug Log References
- TypeScript configuration updated with ES2020 target and forceConsistentCasingInFileNames
- Mongoose 8.18.0 installed successfully
- Jest testing framework configured with Next.js integration
- Module resolution configured for @/ alias mapping

### Completion Notes List
- All tasks completed successfully
- Project structure follows architecture specifications
- Database connection utility implemented with proper error handling
- Comprehensive TypeScript types defined for all entities
- Error handling utilities with logging capabilities implemented
- Test suite created with 19 passing tests for types validation
- Health check API endpoint created for database connection testing

### File List
**New Files Created:**
- `src/lib/database.ts` - MongoDB connection utility with error handling
- `src/types/index.ts` - Comprehensive TypeScript type definitions
- `src/utils/errorHandler.ts` - Error handling utilities and logging
- `src/app/api/health/route.ts` - Health check API endpoint
- `tests/api/database.test.ts` - Database connection tests
- `tests/api/errorHandler.test.ts` - Error handling tests
- `tests/api/types.test.ts` - Type definition tests
- `jest.config.js` - Jest configuration for testing
- `jest.setup.js` - Jest setup file
- `.env.local.example` - Environment variables template

**Modified Files:**
- `tsconfig.json` - Updated compiler options
- `package.json` - Added mongoose dependency and test scripts

**Directories Created:**
- `src/components/` (ui/, graph/, layout/, pages/)
- `src/hooks/`
- `src/context/`
- `src/services/`
- `src/utils/`
- `src/lib/`
- `src/types/`
- `src/app/api/` (conversations/, chat/, sync/, health/)
- `src/app/chat/`
- `tests/` (components/, api/, e2e/)

## QA Results
*Results from QA Agent review will be populated here after implementation*
