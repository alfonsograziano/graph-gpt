# Story 2.3: Node State Management and Loading

## Status
Done

## Story

**As a** user,
**I want** to see my message displayed and a loading state when I submit,
**so that** I know my request is being processed.

## Acceptance Criteria

1. When user submits message, input field is hidden and message is displayed
2. Loading state shows "Generating..." text with appropriate loading indicator
3. Node background remains light-gray during loading
4. Loading state is visually distinct and user-friendly
5. Node maintains proper dimensions during state transitions
6. State transitions are smooth and don't cause layout shifts

## Tasks / Subtasks

- [x] Task 1: Implement Node State Transitions (AC: 1, 5, 6)
  - [x] Add state management for node transitions (input → loading → completed)
  - [x] Implement smooth transitions between states
  - [x] Ensure node dimensions remain consistent during transitions
  - [x] Add proper state validation and error handling

- [x] Task 2: Create Loading State Component (AC: 2, 3, 4)
  - [x] Create NodeLoading component for loading state
  - [x] Implement "Generating..." text with loading indicator
  - [x] Apply light-gray background styling during loading
  - [x] Ensure loading state is visually distinct and user-friendly

- [x] Task 3: Update ConversationNode Component (AC: 1, 5, 6)
  - [x] Modify ConversationNode to handle loading state
  - [x] Hide input field when message is submitted
  - [x] Display submitted message in loading state
  - [x] Implement smooth state transitions with CSS animations

- [x] Task 4: Implement State Management Logic (AC: 1, 5, 6)
  - [x] Add loading state to Node type and state management
  - [x] Implement state transition logic in ConversationNode
  - [x] Handle state updates from parent components
  - [x] Ensure proper cleanup and error handling

- [x] Task 5: Add Loading Indicators and Animations (AC: 2, 4, 6)
  - [x] Integrate LoadingSpinner component for loading indicator
  - [x] Add smooth CSS transitions for state changes
  - [x] Implement fade-in/fade-out animations
  - [x] Ensure animations don't cause layout shifts

- [x] Task 6: Create Unit Tests (AC: 1-6)
  - [x] Test node state transitions
  - [x] Test loading state display and functionality
  - [x] Test smooth transitions and animations
  - [x] Test error handling during state transitions

## Dev Notes

### Previous Story Insights
**Story 2.2 Context** [Source: stories/2.2.story.md]
- ConversationNode component exists with input state
- NodeInput subcomponent handles input field and submission
- Default node creation and positioning is implemented
- React Flow integration is complete

**Story 2.1 Context** [Source: stories/2.1.story.md]
- React Flow canvas is integrated and configured
- GraphCanvas component handles node positioning and layout
- TypeScript types are defined for React Flow elements

### Data Models
**Node Interface** [Source: types/index.ts]
```typescript
interface Node {
  id: string;
  conversationId: string;
  type: NodeType; // "input" | "loading" | "completed"
  userMessage: string;
  assistantResponse: string;
  position: Position; // { x: number; y: number }
  createdAt: Date;
  updatedAt: Date;
  parentNodeId?: string;
}
```

**NodeType Definition** [Source: types/index.ts]
```typescript
type NodeType = "input" | "loading" | "completed";
```

### Component Specifications
**ConversationNode Component** [Source: architecture/frontend-architecture.md#component-organization]
- Location: `src/components/graph/ConversationNode.tsx`
- Props: `node: Node`, `isActive: boolean`, `onNodeClick: (nodeId: string) => void`, `onMessageSubmit: (message: string) => void`
- Handles different node states (input, loading, completed)
- State transitions: input → loading → completed

**NodeLoading Component** [Source: architecture/frontend-architecture.md#component-organization]
- Location: `src/components/graph/NodeLoading.tsx`
- Props: `message: string`, `isLoading: boolean`
- Displays submitted message with loading indicator
- Light-gray background with "Generating..." text

**LoadingSpinner Component** [Source: components/ui/LoadingSpinner.tsx]
- Location: `src/components/ui/LoadingSpinner.tsx`
- Props: `size?: "sm" | "md" | "lg"`, `className?: string`
- Sizes: sm (h-4 w-4), md (h-8 w-8), lg (h-12 w-12)
- Blue color: `text-blue-600`
- Accessibility: `role="status"`, `aria-label="Loading"`

### File Locations
**Component Files** [Source: architecture/unified-project-structure.md]
- Main component: `src/components/graph/ConversationNode.tsx`
- Loading component: `src/components/graph/NodeLoading.tsx`
- UI component: `src/components/ui/LoadingSpinner.tsx`
- Types: `src/types/index.ts` (shared types)
- Tests: `tests/components/graph/ConversationNode.test.tsx`, `tests/components/graph/NodeLoading.test.tsx`

**Styling** [Source: architecture/tech-stack.md]
- Tailwind CSS for styling
- Light-gray background: `bg-gray-200` or `bg-gray-100`
- Smooth transitions: `transition-all duration-300 ease-in-out`
- Loading indicator: Use existing LoadingSpinner component

### State Management
**Node State Transitions** [Source: architecture/frontend-architecture.md#state-management-patterns]
- Input state: User can type and submit message
- Loading state: Message submitted, waiting for response
- Completed state: Response received, node is complete
- State updates through React Context and useReducer

**State Management Patterns** [Source: architecture/frontend-architecture.md#state-management-patterns]
- Centralized state for graph data
- Immutable updates through reducers
- Optimistic updates with rollback on failure
- Proper error handling and state validation

### Testing Requirements
**Test File Locations** [Source: architecture/testing-strategy.md#frontend-tests]
- Test files: `tests/components/graph/ConversationNode.test.tsx`, `tests/components/graph/NodeLoading.test.tsx`
- Testing framework: Jest + React Testing Library
- Test patterns: Component rendering, state transitions, user interactions

**Test Standards** [Source: architecture/testing-strategy.md#frontend-component-test]
- Use `render`, `screen`, `fireEvent` from React Testing Library
- Mock node data and state management for testing
- Test state transitions and loading states
- Test animations and smooth transitions

### Technical Constraints
**State Management** [Source: architecture/frontend-architecture.md#state-management-patterns]
- Use React Context for global graph state
- Local state for component-specific state
- Proper state validation and error handling

**Performance Considerations** [Source: architecture/frontend-architecture.md#state-management-patterns]
- Smooth transitions without layout shifts
- Efficient state updates and re-renders
- Proper cleanup of animations and timers

**Accessibility** [Source: architecture/coding-standards.md]
- Loading indicators with proper ARIA labels
- Screen reader support for state changes
- Keyboard navigation during state transitions

### Testing
**Test File Locations**: 
- `tests/components/graph/ConversationNode.test.tsx`
- `tests/components/graph/NodeLoading.test.tsx`

**Test Standards**: 
- Use Jest + React Testing Library
- Test component rendering with different node states
- Test state transitions and loading states
- Test animations and smooth transitions
- Mock state management and event handlers

**Testing Frameworks**: Jest, React Testing Library, @testing-library/jest-dom

**Specific Testing Requirements for this Story**:
- Test node state transitions (input → loading → completed)
- Test loading state display and functionality
- Test smooth transitions and animations
- Test error handling during state transitions
- Test accessibility features and ARIA labels

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (Dev Agent)

### Debug Log References
- All tests passing: 23/23 tests passed
- No linting errors detected
- Component integration successful

### Completion Notes List
- ✅ Created NodeLoading component with proper styling and loading indicator
- ✅ Updated ConversationNode component to use NodeLoading for loading state
- ✅ Implemented smooth CSS transitions (transition-all duration-300 ease-in-out)
- ✅ Added state-based background styling (white for input/completed, gray-200 for loading)
- ✅ Ensured consistent min-width (300px) across all node states
- ✅ Integrated LoadingSpinner component with proper accessibility attributes
- ✅ Created comprehensive unit tests covering all acceptance criteria
- ✅ All tests passing with 100% coverage of new functionality

### File List
**New Files:**
- `src/components/graph/NodeLoading.tsx` - Loading state component
- `tests/components/graph/NodeLoading.test.tsx` - Unit tests for NodeLoading component

**Modified Files:**
- `src/components/graph/ConversationNode.tsx` - Updated to use NodeLoading component and improved state transitions
- `tests/components/graph/ConversationNode.test.tsx` - Enhanced tests for new functionality

## QA Results
*To be populated by QA Agent*
