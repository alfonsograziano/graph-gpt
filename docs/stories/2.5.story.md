# Story 2.5: Node Activation and Path Calculation

## Status
Draft

## Story

**As a** user,
**I want** to click on nodes to activate them and see the conversation path,
**so that** I can understand which nodes will be used as context for new messages.

## Acceptance Criteria

1. Clicking a node activates it and all nodes in path back to source
2. Active nodes have white background, inactive nodes have light-gray background
3. Path calculation correctly identifies all nodes from clicked node to root
4. Visual feedback clearly shows which nodes are active
5. Node activation works correctly regardless of graph complexity
6. Activation state is maintained until user clicks different node
7. Path calculation handles complex branching scenarios correctly

## Tasks / Subtasks

- [ ] Task 1: Implement Path Calculation Algorithm (AC: 3, 7)
  - [ ] Create graphTraversal utility for path calculation
  - [ ] Implement recursive path finding from node to root
  - [ ] Handle complex branching scenarios and multiple paths
  - [ ] Add validation for circular references and orphaned nodes
  - [ ] Create unit tests for path calculation edge cases

- [ ] Task 2: Update GraphContext State Management (AC: 1, 6)
  - [ ] Add activeNodePath to GraphState interface
  - [ ] Implement SET_ACTIVE_PATH action in reducer
  - [ ] Add path calculation logic to node click handler
  - [ ] Ensure state updates are immutable and optimized
  - [ ] Add proper error handling for invalid node references

- [ ] Task 3: Enhance ConversationNode Component (AC: 2, 4)
  - [ ] Update ConversationNode to use activeNodePath from context
  - [ ] Implement conditional styling based on activation state
  - [ ] Add smooth transitions for background color changes
  - [ ] Ensure proper visual feedback for active/inactive states
  - [ ] Add accessibility attributes for screen readers

- [ ] Task 4: Update GraphCanvas Click Handling (AC: 1, 5)
  - [ ] Modify GraphCanvas to handle node click events
  - [ ] Implement path calculation on node click
  - [ ] Update activeNodePath state through GraphContext
  - [ ] Handle edge cases (clicking same node, invalid nodes)
  - [ ] Ensure proper event propagation and cleanup

- [ ] Task 5: Add Visual Path Indicators (AC: 4)
  - [ ] Create visual indicators for active path
  - [ ] Implement edge highlighting for active connections
  - [ ] Add subtle animations for path activation
  - [ ] Ensure visual indicators don't interfere with readability
  - [ ] Make indicators accessible and keyboard navigable

- [ ] Task 6: Create Unit Tests (AC: 1-7)
  - [ ] Test path calculation algorithm with various graph structures
  - [ ] Test node activation and state management
  - [ ] Test visual feedback and styling changes
  - [ ] Test edge cases and error handling
  - [ ] Test accessibility and keyboard navigation

## Dev Notes

### Previous Story Insights
**Story 2.4 Context** [Source: stories/2.4.story.md]
- Node completion and branch creation functionality is implemented
- NodeCompleted component displays user message, separator, and LLM response
- Circular "+" button for branch creation is available
- Node background changes to white when active (basic implementation)
- Markdown rendering for LLM responses is complete

**Story 2.3 Context** [Source: stories/2.3.story.md]
- Node state management and loading states are implemented
- ConversationNode component handles input and loading states
- NodeLoading component exists for loading state display
- State transitions from input → loading → completed are working

**Story 2.2 Context** [Source: stories/2.2.story.md]
- ConversationNode component exists with input state
- NodeInput subcomponent handles input field and submission
- Default node creation and positioning is implemented
- React Flow integration is complete

**Story 2.1 Context** [Source: stories/2.1.story.md]
- React Flow canvas is integrated and configured
- GraphCanvas component handles node positioning and layout
- TypeScript types are defined for React Flow elements

### Data Models
**Node Interface** [Source: architecture/data-models.md#node]
```typescript
interface Node {
  id: string;
  conversationId: string;
  type: 'input' | 'loading' | 'completed';
  userMessage: string;
  assistantResponse: string;
  position: Position;
  createdAt: Date;
  updatedAt: Date;
  parentNodeId?: string;
}
```

**Edge Interface** [Source: architecture/data-models.md#edge]
```typescript
interface Edge {
  id: string;
  conversationId: string;
  sourceNodeId: string;
  targetNodeId: string;
  type: 'auto' | 'manual' | 'markdown';
  createdAt: Date;
  metadata?: EdgeMetadata;
}
```

**GraphState Interface** [Source: architecture/frontend-architecture.md#state-structure]
```typescript
interface GraphState {
  conversations: Conversation[];
  currentConversation: Conversation | null;
  activeNodePath: string[];
  isLoading: boolean;
  error: string | null;
}
```

**GraphAction Interface** [Source: architecture/frontend-architecture.md#state-structure]
```typescript
interface GraphAction {
  type: 'SET_CONVERSATIONS' | 'SET_CURRENT_CONVERSATION' | 'UPDATE_NODE' | 'ADD_EDGE' | 'SET_ACTIVE_PATH';
  payload: any;
}
```

### Component Specifications
**ConversationNode Component** [Source: architecture/frontend-architecture.md#component-organization]
- Location: `src/components/graph/ConversationNode.tsx`
- Props: `node: Node`, `isActive: boolean`, `onNodeClick: (nodeId: string) => void`, `onMessageSubmit: (message: string) => void`
- Handles different node states (input, loading, completed)
- State transitions: input → loading → completed
- **NEW**: Uses activeNodePath from GraphContext to determine activation state

**GraphCanvas Component** [Source: architecture/frontend-architecture.md#component-organization]
- Location: `src/components/graph/GraphCanvas.tsx`
- Props: `conversation: Conversation`, `onNodeClick: (nodeId: string) => void`
- Handles React Flow canvas and node positioning
- **NEW**: Implements path calculation on node click events

**GraphContext Component** [Source: architecture/frontend-architecture.md#component-organization]
- Location: `src/context/GraphContext.tsx`
- Provides global graph state management
- **NEW**: Manages activeNodePath state and path calculation logic

**GraphTraversal Utility** [Source: architecture/frontend-architecture.md#component-organization]
- Location: `src/utils/graphTraversal.ts`
- **NEW**: Utility functions for path calculation and graph traversal
- Functions: `calculatePathToRoot`, `findNodeById`, `validatePath`

### File Locations
**Component Files** [Source: architecture/unified-project-structure.md]
- Main component: `src/components/graph/ConversationNode.tsx`
- Canvas component: `src/components/graph/GraphCanvas.tsx`
- Context: `src/context/GraphContext.tsx`
- Utility: `src/utils/graphTraversal.ts`
- Types: `src/types/index.ts` (shared types)
- Tests: `tests/components/graph/ConversationNode.test.tsx`, `tests/components/graph/GraphCanvas.test.tsx`, `tests/utils/graphTraversal.test.ts`

**Styling** [Source: architecture/tech-stack.md]
- Tailwind CSS for styling
- White background for active nodes: `bg-white`
- Light-gray background for inactive nodes: `bg-gray-200` or `bg-gray-100`
- Path indicators: `border-blue-500` or `ring-2 ring-blue-500`
- Smooth transitions: `transition-colors duration-200`

### State Management
**Node Activation Logic** [Source: architecture/frontend-architecture.md#state-management-patterns]
- Active nodes have white background
- Inactive nodes have light-gray background
- Activation state managed through GraphContext
- Visual feedback for active/inactive states
- Path calculation updates activeNodePath array

**Path Calculation** [Source: architecture/frontend-architecture.md#state-management-patterns]
- Recursive traversal from clicked node to root
- Handles complex branching scenarios
- Validates node references and prevents circular paths
- Updates activeNodePath state through reducer

**State Management Patterns** [Source: architecture/frontend-architecture.md#state-management-patterns]
- Centralized state for graph data
- Immutable updates through reducers
- Optimistic updates with rollback on failure
- Proper error handling and state validation

### Testing Requirements
**Test File Locations** [Source: architecture/testing-strategy.md#frontend-tests]
- Test files: `tests/components/graph/ConversationNode.test.tsx`, `tests/components/graph/GraphCanvas.test.tsx`, `tests/utils/graphTraversal.test.ts`
- Testing framework: Jest + React Testing Library
- Test patterns: Component rendering, state transitions, user interactions, utility functions

**Test Standards** [Source: architecture/testing-strategy.md#frontend-component-test]
- Use `render`, `screen`, `fireEvent` from React Testing Library
- Mock node data and state management for testing
- Test path calculation with various graph structures
- Test node activation and visual feedback
- Test edge cases and error handling

### Technical Constraints
**Path Calculation Algorithm** [Source: architecture/frontend-architecture.md#state-management-patterns]
- Must handle complex branching scenarios
- Prevent infinite loops and circular references
- Efficient traversal for large graphs
- Proper error handling for invalid node references

**State Management** [Source: architecture/frontend-architecture.md#state-management-patterns]
- Use React Context for global graph state
- Local state for component-specific state
- Proper state validation and error handling
- Immutable state updates

**Performance Considerations** [Source: architecture/frontend-architecture.md#state-management-patterns]
- Efficient path calculation without blocking UI
- Proper memoization for expensive operations
- Smooth transitions without layout shifts
- Optimized re-renders for large graphs

**Accessibility** [Source: architecture/coding-standards.md]
- Proper ARIA labels for active/inactive states
- Screen reader support for path information
- Keyboard navigation for node activation
- Proper focus management and visual indicators

### Testing
**Test File Locations**: 
- `tests/components/graph/ConversationNode.test.tsx`
- `tests/components/graph/GraphCanvas.test.tsx`
- `tests/utils/graphTraversal.test.ts`

**Test Standards**: 
- Use Jest + React Testing Library
- Test path calculation with various graph structures
- Test node activation and visual feedback
- Test edge cases and error handling
- Mock state management and event handlers

**Testing Frameworks**: Jest, React Testing Library, @testing-library/jest-dom

**Specific Testing Requirements for this Story**:
- Test path calculation algorithm with linear and branched graphs
- Test node activation and background color changes
- Test visual path indicators and edge highlighting
- Test complex branching scenarios and edge cases
- Test accessibility and keyboard navigation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
*To be populated by Dev Agent*

### Debug Log References
*To be populated by Dev Agent*

### Completion Notes List
*To be populated by Dev Agent*

### File List
*To be populated by Dev Agent*

## QA Results
*To be populated by QA Agent*
