# Story 4.1: Markdown Element Anchors

## Status
Draft

## Story
**As a** user,
**I want** to create new conversation branches from specific parts of markdown content,
**so that** I can explore related topics in context.

## Acceptance Criteria

1. Hovering over markdown elements shows anchor points
2. Anchor points are visually distinct and properly positioned
3. Clicking anchor creates new node with contextual connection
4. New node includes context from parent node content
5. Anchor system works with all markdown element types
6. Element path identification is unique and stable
7. Anchor creation maintains proper graph structure

## Tasks / Subtasks

- [ ] Task 1: Implement markdown element detection and anchor rendering (AC: 1, 2)
  - [ ] Create MarkdownAnchor component for hover detection
  - [ ] Implement element path identification system
  - [ ] Add visual styling for anchor points
  - [ ] Integrate with existing MarkdownRenderer component

- [ ] Task 2: Implement anchor click handling and node creation (AC: 3, 4, 7)
  - [ ] Create anchor click handler in ConversationNode
  - [ ] Implement context extraction from parent node content
  - [ ] Add new node creation with contextual connection
  - [ ] Update graph state management for new nodes

- [ ] Task 3: Support all markdown element types (AC: 5, 6)
  - [ ] Extend anchor system to support headers, paragraphs, lists, code blocks
  - [ ] Implement stable element path identification
  - [ ] Add anchor positioning for different element types
  - [ ] Test anchor functionality across all markdown elements

- [ ] Task 4: Update data models and API integration (AC: 7)
  - [ ] Extend Edge model to support markdown anchor metadata
  - [ ] Update conversation service for markdown anchor edges
  - [ ] Add API endpoints for anchor-based node creation
  - [ ] Implement backend validation for anchor connections

- [ ] Task 5: Testing and validation (AC: 1-7)
  - [ ] Write unit tests for MarkdownAnchor component
  - [ ] Add integration tests for anchor click flow
  - [ ] Create E2E tests for markdown anchor functionality
  - [ ] Test anchor system with complex markdown content

## Dev Notes

### Previous Story Insights
No previous stories in Epic 4 - this is the first story.

### Data Models
[Source: architecture/data-models.md#edge]
- Edge model already supports markdown anchor metadata through `EdgeMetadata.markdownElementId` and `EdgeMetadata.contextSnippet`
- Edge type includes 'markdown' as a valid type for anchor-based connections
- Node model supports `parentNodeId` for tracking relationships

### API Specifications
[Source: architecture/api-specification.md]
- Need to extend conversation API to handle markdown anchor edge creation
- Edge creation should include markdown element identification and context extraction
- API should validate anchor connections and maintain graph integrity

### Component Specifications
[Source: architecture/frontend-architecture.md#component-organization]
- MarkdownAnchor component should be created in `src/components/graph/`
- Integration with existing MarkdownRenderer component in same directory
- Component should follow established patterns with proper TypeScript interfaces

### File Locations
[Source: architecture/unified-project-structure.md]
- New component: `src/components/graph/MarkdownAnchor.tsx`
- Update existing: `src/components/graph/MarkdownRenderer.tsx`
- Update existing: `src/components/graph/ConversationNode.tsx`
- Update types: `src/types/edge.ts` (if needed)
- Update service: `src/services/conversationService.ts`
- API route: `src/app/api/conversations/[id]/edges/route.ts`

### Testing Requirements
[Source: architecture/testing-strategy.md#frontend-tests]
- Unit tests: `tests/components/graph/MarkdownAnchor.test.tsx`
- Integration tests: `tests/components/graph/MarkdownRenderer.test.tsx`
- E2E tests: `tests/e2e/markdown-anchors.spec.ts`
- Test file location follows `tests/components/` structure
- Use Jest + React Testing Library for component tests
- Use Playwright for E2E tests

### Technical Constraints
[Source: architecture/coding-standards.md]
- All API calls must go through service layer in `src/services/`
- Type sharing through `src/types/` directory
- Error handling through standard error handler

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]
- **Test file location**: `tests/components/graph/` for component tests, `tests/e2e/` for E2E tests
- **Testing frameworks**: Jest + React Testing Library for unit tests, Playwright for E2E tests
- **Test patterns**: Follow established component test patterns with proper mocking
- **E2E requirements**: Test complete user flow from markdown rendering to anchor creation
- **Coverage requirements**: All anchor functionality must be covered by tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-01-XX | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes List
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent_
