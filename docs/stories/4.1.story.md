# Story 4.1: Markdown Element Anchors with Dual-Side Branch Buttons

## Status
Done

## Story
**As a** user,
**I want** to create new conversation branches from specific parts of markdown content using branch buttons on both left and right sides,
**so that** I can explore related topics in context with flexible positioning options.

## Acceptance Criteria

1. Hovering over markdown elements shows branch buttons on both left and right sides
2. Branch buttons are visually distinct and properly positioned with 25px offset from element edges
3. Clicking left branch button creates new node positioned 100px to the left of parent node
4. Clicking right branch button creates new node positioned 100px to the right of parent node
5. New node includes context from parent node content and maintains proper graph structure
6. Branch button system works with all markdown element types (headers, paragraphs, lists, code blocks, etc.)
7. Element path identification is unique and stable across all markdown elements
8. Handle IDs are generated using stable, unique identifiers based on element content and position
9. Branch creation maintains proper graph structure and edge connections

## Tasks / Subtasks

- [ ] Task 1: Implement dual-side branch button system for all markdown elements (AC: 1, 2, 6, 7, 8)
  - [ ] Update MarkdownItemWithHandles to support all markdown element types
  - [ ] Implement stable, unique handle ID generation system using element content hash and position
  - [ ] Add left and right branch button positioning with 25px offset from element edges
  - [ ] Extend MarkdownRenderer to wrap all markdown elements with MarkdownItemWithHandles
  - [ ] Ensure consistent styling and behavior across all element types

- [ ] Task 2: Implement directional node creation with proper positioning (AC: 3, 4, 5, 9)
  - [ ] Create branch button click handlers for left and right positioning
  - [ ] Implement context extraction from parent node content
  - [ ] Add new node creation with 100px horizontal spacing (left/right based on button clicked)
  - [ ] Update graph state management for directional node creation
  - [ ] Ensure proper edge connections and graph structure maintenance

- [ ] Task 3: Enhance handle ID system for stability and uniqueness (AC: 7, 8)
  - [ ] Replace current handle ID generation with content-based hashing
  - [ ] Implement position-aware ID generation for multiple elements of same type
  - [ ] Add element path identification system for complex markdown structures
  - [ ] Ensure handle IDs remain stable across re-renders and content updates

- [ ] Task 4: Update data models and API integration (AC: 9)
  - [ ] Extend Edge model to support directional branch metadata
  - [ ] Update conversation service for directional branch creation
  - [ ] Add API endpoints for left/right branch node creation
  - [ ] Implement backend validation for directional branch connections

- [ ] Task 5: Testing and validation (AC: 1-9)
  - [ ] Write unit tests for updated MarkdownItemWithHandles component
  - [ ] Add integration tests for dual-side branch button functionality
  - [ ] Create E2E tests for directional node creation
  - [ ] Test branch button system with complex markdown content across all element types

## Dev Notes

### Previous Story Insights
No previous stories in Epic 4 - this is the first story.

### Data Models
[Source: architecture/data-models.md#edge]
- Edge model already supports markdown anchor metadata through `EdgeMetadata.markdownElementId` and `EdgeMetadata.contextSnippet`
- Edge type includes 'markdown' as a valid type for anchor-based connections
- Node model supports `parentNodeId` for tracking relationships

### API Specifications
[Source: architecture/api-specification.md]
- Need to extend conversation API to handle markdown anchor edge creation
- Edge creation should include markdown element identification and context extraction
- API should validate anchor connections and maintain graph integrity

### Component Specifications
[Source: architecture/frontend-architecture.md#component-organization]
- MarkdownAnchor component should be created in `src/components/graph/`
- Integration with existing MarkdownRenderer component in same directory
- Component should follow established patterns with proper TypeScript interfaces

### File Locations
[Source: architecture/unified-project-structure.md]
- New component: `src/components/graph/MarkdownAnchor.tsx`
- Update existing: `src/components/graph/MarkdownRenderer.tsx`
- Update existing: `src/components/graph/ConversationNode.tsx`
- Update types: `src/types/edge.ts` (if needed)
- Update service: `src/services/conversationService.ts`
- API route: `src/app/api/conversations/[id]/edges/route.ts`

### Testing Requirements
[Source: architecture/testing-strategy.md#frontend-tests]
- Unit tests: `tests/components/graph/MarkdownAnchor.test.tsx`
- Integration tests: `tests/components/graph/MarkdownRenderer.test.tsx`
- E2E tests: `tests/e2e/markdown-anchors.spec.ts`
- Test file location follows `tests/components/` structure
- Use Jest + React Testing Library for component tests
- Use Playwright for E2E tests

### Technical Constraints
[Source: architecture/coding-standards.md]
- All API calls must go through service layer in `src/services/`
- Type sharing through `src/types/` directory
- Error handling through standard error handler

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]
- **Test file location**: `tests/components/graph/` for component tests, `tests/e2e/` for E2E tests
- **Testing frameworks**: Jest + React Testing Library for unit tests, Playwright for E2E tests
- **Test patterns**: Follow established component test patterns with proper mocking
- **E2E requirements**: Test complete user flow from markdown rendering to anchor creation
- **Coverage requirements**: All anchor functionality must be covered by tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-01-XX | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes List
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent_
